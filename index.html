<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Naksha</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#041726;
    --card: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.02);
    --accent:#00fff6;
    --muted:rgba(255,255,255,0.65);
    --danger:#ff5c6c;
    --success:#7cffb2;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#021426,#041426);color:#e9f8f7;}
  .app{display:flex;flex-direction:column;height:100vh;gap:8px;padding:10px;}
  header{height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:40px;height:40;border-radius:8px;background:linear-gradient(90deg,#00fff6,#7cffb2);display:flex;align-items:center;justify-content:center;color:#002b2b;font-weight:800}
  .title{font-weight:700}
  #map{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 18px 48px rgba(0,0,0,0.6)}
  .controls{position:absolute;left:12px;top:80px;z-index:400;display:flex;flex-direction:column;gap:8px}
  .control-btn{background:var(--card);border-radius:10px;padding:8px 10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-width:48px;text-align:center;font-weight:700}
  .floating-info{position:absolute;right:12px;top:80px;z-index:400;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:10px;border-radius:10px;min-width:140px}
  .bottom-drawer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#031825,#02141a);border-top-left-radius:14px;border-top-right-radius:14px;padding:8px 12px;z-index:500;transform:translateY(92%);transition:transform .28s cubic-bezier(.2,.9,.3,1);box-shadow:0 -20px 40px rgba(0,0,0,0.6)}
  .drawer-open{transform:translateY(8%);}
  .drawer-handle{width:48px;height:6px;background:rgba(255,255,255,0.06);border-radius:20px;margin:6px auto}
  .drawer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding-bottom:12px}
  .card{background:var(--glass);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted);font-size:13px}
  .pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  .tiny{font-size:12px;color:var(--muted)}
  .vehicle-icon{font-size:12px;transform:translate(-50%,-50%);padding:4px;border-radius:6px;background:rgba(0,0,0,0.4)}
  .marker-small{width:18px;height:18px;border-radius:6px;display:inline-block;line-height:18px;text-align:center;font-size:11px}
  .store-marker{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
  .modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:800;padding:16px}
  .modal.show{display:flex}
  .modal .panel{width:100%;max-width:520px;background:linear-gradient(180deg,#021022,#031626);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e9f8f7}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;background:var(--card);border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,#00fff6,#7cffb2);color:#022b26;border:none}
  .list{max-height:260px;overflow:auto;padding-right:6px}
  .vehicle-filter{display:flex;gap:6px;flex-wrap:wrap}
  .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700}
  .small-muted{font-size:12px;color:var(--muted)}
  footer{height:10px}
  @media(min-width:900px){ .drawer-grid{grid-template-columns:repeat(4,1fr)} .controls{left:24px;top:100px} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo"><img src="a.png" alt="logo"width="35px"height="30px"></img></div>
      <div>
        <div class="title"></img></div>
        <div class="tiny"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="pill" id="filterCount">Vehicles: 0</div>
      <button class="control-btn" id="locBtn" title="Find my location">üìç</button>
      <button class="control-btn" id="openDrawerBtn">‚ò∞</button>
    </div>
  </header>

  <div id="map"></div>

  <!-- Left controls -->
  <div class="controls" aria-hidden>
    <button class="control-btn" id="toggleVehicles">Hide Vehicles</button>
    <button class="control-btn" id="showAmbulanceRoutes">Ambulance routes</button>
  </div>

  <div class="floating-info" id="notifBox" style="display:none"></div>

  <!-- Bottom drawer -->
  <div class="bottom-drawer" id="drawer">
    <div class="drawer-handle" id="drawerHandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 2px">
      <div class="muted">App features</div>
      <div style="display:flex;gap:6px">
        <button class="btn" id="openProfile">Profile</button>
        <button class="btn" id="openBookings">Bookings</button>
      </div>
    </div>

    <div class="drawer-grid" id="drawerGrid">
      <div class="card">
        <div class="muted">Vehicle Filters</div>
        <div style="height:8px"></div>
        <div class="vehicle-filter" id="vehicleFilters">
          <!-- checkboxes added by JS -->
        </div>
      </div>

      <div class="card">
        <div class="muted">Stores</div>
        <div style="height:8px"></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="row">
            <select id="storeSelect"><option value="">Choose category</option></select>
            <button class="btn" id="listStoresBtn">List</button>
          </div>
          <div class="small-muted">Tap a store marker to open its product list.</div>
        </div>
      </div>

      <div class="card">
        <div class="muted">Quick actions</div>
        <div style="height:8px"></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" id="toggleVehicleVisibility">Toggle vehicles</button>
          <button class="btn" id="centerMapBtn">Center map</button>
          <button class="btn" id="simulateAmbulanceBtn">Simulate Ambulance</button>
        </div>
      </div>

      <div class="card">
        <div class="muted">Settings</div>
        <div style="height:8px"></div>
        <label class="tiny">Map zoom</label>
        <input id="zoomInput" type="range" min="10" max="18" value="13"/>
        <div style="height:8px"></div>
        <label class="tiny">Show store icons</label>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="btn" id="toggleStores">Toggle Stores</button>
        </div>
      </div>
    </div>

    <div style="padding:10px 0">
      <div class="muted">Recent notifications</div>
      <div class="list" id="notifList" style="margin-top:8px"></div>
    </div>
  </div>

  <footer></footer>
</div>

<!-- Modals -->
<div class="modal" id="vehicleModal"><div class="panel"><div id="vehicleModalContent"></div><div style="height:10px"></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="closeVehicleModal">Close</button></div></div></div>

<div class="modal" id="storeModal"><div class="panel"><h3 id="storeTitle">Store</h3><div id="productList" class="list"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button class="btn" id="closeStore">Close</button></div></div></div>

<div class="modal" id="orderModal"><div class="panel"><h3>Place Order</h3><div id="orderProduct"></div><div style="height:8px"></div><label class="tiny">Mobile number</label><input id="orderPhone" placeholder="+91 98xxxx"/><label class="tiny">Address</label><textarea id="orderAddress" rows="2"></textarea><label class="tiny">Quantity</label><input id="orderQty" type="number" value="1" min="1"/><div style="height:8px"></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="confirmOrderBtn" class="primary">Confirm Order</button><button class="btn" id="cancelOrderBtn">Cancel</button></div></div></div>

<div class="modal" id="profileModal"><div class="panel"><h3>Profile & Documents</h3><div class="muted tiny">Dummy personal documents</div><div style="height:8px"></div><div id="docList" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div><div style="height:8px"></div><div style="display:flex;justify-content:flex-end"><button class="btn" id="closeProfile">Close</button></div></div></div>

<div class="modal" id="bookModal"><div class="panel"><div id="bookContent"></div><div style="height:8px"></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="closeBookModal">Close</button></div></div></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------------------------
  APP STATE & DUMMY DATA
----------------------------*/
const CATEGORIES = ['General Store','Medical Store','Mechanical','Clothes','Vegetables','Stationery'];
const VEHICLE_TYPES = [
  {key:'taxi',icon:'üöï',label:'Taxi'},
  {key:'car',icon:'üöó',label:'Car'},
  {key:'bike',icon:'üõµ',label:'Bike'},
  {key:'police',icon:'üöì',label:'Police'},
  {key:'ambulance',icon:'üöë',label:'Ambulance'},
  {key:'delivery',icon:'üöö',label:'Delivery'}
];

const state = {
  map: null,
  vehicles: [],
  vehicleMarkers: [],
  vehicleVisible: true,
  stores: [],
  storeMarkers: [],
  userMarker: null,
  userCoords: null,
  ambulanceRoutes: [],
  filters: new Set(VEHICLE_TYPES.map(v=>v.key)),
  drawerOpen: false
};

/* ---------------------------
  UTIL
----------------------------*/
function $(id){return document.getElementById(id);}
function rand(min,max){return Math.random()*(max-min)+min}
function rndPick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function uid(){return Math.random().toString(36).slice(2,9)}

/* ---------------------------
  INIT MAP
----------------------------*/
function initMap(){
  const map = L.map('map',{zoomControl:false}).setView([28.6139,77.2090],13);
  state.map = map;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OSM'}).addTo(map);
  // add center marker if needed
  // create stores & vehicles
  generateStores();
  generateVehicles(110);
  addStoreMarkers();
  addVehicleMarkers();
  bindUI();
}

/* ---------------------------
  STORES & PRODUCTS
----------------------------*/
function generateStores(){
  // distribute store markers around center
  const baseLat = 28.6139, baseLng = 77.2090;
  CATEGORIES.forEach((cat,ci)=>{
    for(let i=0;i<3;i++){ // 3 stores per category = 18 stores
      const lat = baseLat + rand(-0.02,0.02);
      const lng = baseLng + rand(-0.02,0.02);
      const id = uid();
      const products = Array.from({length:30},(_,k)=>({
        id: id+'-p'+k,
        name: `${cat} Item ${k+1}`,
        price: (rand(20,999).toFixed(0)),
        desc: 'Dummy product for demo',
        img: `https://via.placeholder.com/80?text=${encodeURIComponent(cat.charAt(0)+ (k+1))}`
      }));
      state.stores.push({id,cat,lat,lng,name: `${cat} Shop ${i+1}`,products});
    }
  });
  // add some more to reach variety
  for(let i=0;i<6;i++){
    const cat = CATEGORIES[i%6];
    const lat = 28.6139 + rand(-0.03,0.03);
    const lng = 77.2090 + rand(-0.03,0.03);
    const id = uid();
    state.stores.push({id,cat,lat,lng,name:`${cat} Extra ${i+1}`,products: Array.from({length:20},(_,k)=>({
      id:id+'-x'+k,name:`${cat} X${k+1}`,price:(rand(10,400).toFixed(0)),desc:'Extra demo',img:`https://via.placeholder.com/80?text=${encodeURIComponent(cat.charAt(0))}`
    }))});
  }

  // populate storeSelect
  const sel = $('storeSelect');
  CATEGORIES.forEach(c=>{ const o = document.createElement('option'); o.value=c; o.innerText=c; sel.appendChild(o) });
}

/* ---------------------------
  STORE MARKERS
----------------------------*/
function addStoreMarkers(){
  // group: marker with category letter
  state.stores.forEach(s=>{
    const el = L.divIcon({className:'store-marker',html:`<div class="store-marker" style="background:#0b3740;padding:4px;border-radius:8px;">${s.cat.charAt(0)}</div>`,iconSize:[30,30],iconAnchor:[15,15]});
    const marker = L.marker([s.lat,s.lng],{icon:el}).addTo(state.map).bindPopup(`<strong>${s.name}</strong><div class="tiny">${s.cat}</div>`);
    marker.on('click',()=>openStore(s));
    state.storeMarkers.push(marker);
  });
}

/* ---------------------------
  VEHICLES (simulate movement)
----------------------------*/
function generateVehicles(n=100){
  const center = [28.6139,77.2090];
  for(let i=0;i<n;i++){
    const type = rndPick(VEHICLE_TYPES);
    const lat = center[0] + rand(-0.035,0.035);
    const lng = center[1] + rand(-0.035,0.035);
    const id = uid();
    const driver = `Dr ${String.fromCharCode(65+Math.floor(Math.random()*24))}${Math.floor(rand(10,99))}`;
    const reg = `${'DL'}${Math.floor(rand(10,99))}-${Math.floor(rand(1000,9999))}`;
    // path for movement: small circle/patrol
    const path = Array.from({length:8},(_,k)=>[lat+Math.sin(k/8*6.28)*rand(0.001,0.007), lng+Math.cos(k/8*6.28)*rand(0.001,0.007)]);
    state.vehicles.push({id,type:type.key,icon:type.icon,label:type.label,lat,lng,driver,reg,path,idx:Math.floor(rand(0,7))});
  }
}

function addVehicleMarkers(){
  state.vehicles.forEach(v=>{
    const el = L.divIcon({className:'vehicle-icon',html:`<div class="marker-small" title="${v.label}">${v.icon}</div>`,iconSize:[24,24],iconAnchor:[12,12]});
    const m = L.marker([v.lat,v.lng],{icon:el}).addTo(state.map);
    m.on('click',()=>onVehicleClick(v,m));
    state.vehicleMarkers.push({id:v.id,marker:m,vehicle:v});
  });
  updateFilterCounter();
  // start animation
  setInterval(moveVehicles,800);
}

function moveVehicles(){
  state.vehicleMarkers.forEach(obj=>{
    const v = obj.vehicle;
    // advance index
    v.idx = (v.idx + 1) % v.path.length;
    const pos = v.path[v.idx];
    obj.marker.setLatLng(pos);
    // small random jitter
    if(Math.random()<0.02){
      v.path = v.path.map(p => [p[0]+rand(-0.0004,0.0004), p[1]+rand(-0.0004,0.0004)]);
    }
    // hide if filtered
    const visible = state.filters.has(v.type) && state.vehicleVisible;
    if(visible){
      if(!state.map.hasLayer(obj.marker)) obj.marker.addTo(state.map);
    } else {
      if(state.map.hasLayer(obj.marker)) state.map.removeLayer(obj.marker);
    }
  });
  updateFilterCounter();
}

/* ---------------------------
  VEHICLE CLICK / BOOK / ROUTE
----------------------------*/
function onVehicleClick(v,marker){
  const html = document.createElement('div');
  html.innerHTML = `<strong>${v.label}</strong> <div class="tiny">${v.driver} ‚Ä¢ ${v.reg}</div><div style="height:8px"></div>`;
  const btnRow = document.createElement('div'); btnRow.style.display='flex'; btnRow.style.justifyContent='flex-end'; btnRow.style.gap='8px';
  // Book button for taxi/car/bike/delivery
  if(['taxi','car','bike','delivery'].includes(v.type)){
    const book = document.createElement('button'); book.className='btn primary'; book.innerText='Book';
    book.onclick = ()=>openBooking(v);
    btnRow.appendChild(book);
  }
  // View route for police/ambulance
  if(['police','ambulance'].includes(v.type)){
    const view = document.createElement('button'); view.className='btn'; view.innerText='View Route';
    view.onclick = ()=>viewRouteForVehicle(v);
    btnRow.appendChild(view);
  }
  html.appendChild(btnRow);
  $('vehicleModalContent').innerHTML = '';
  $('vehicleModalContent').appendChild(html);
  $('vehicleModal').classList.add('show');
}

$('closeVehicleModal').addEventListener('click',()=>$('vehicleModal').classList.remove('show'));

/* ---------------------------
  BOOKING (frontend)
----------------------------*/
function openBooking(v){
  $('bookContent').innerHTML = `<h3>Booking</h3><div class="muted tiny">${v.label} ‚Ä¢ ${v.driver} ‚Ä¢ ${v.reg}</div><div style="height:8px"></div><div style="display:flex;gap:8px"><input id="bkPhone" placeholder="Mobile number"/><input id="bkName" placeholder="Your name"/></div><div style="height:8px"></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn primary" id="confirmBook">Confirm</button></div>`;
  $('bookModal').classList.add('show');
  $('confirmBook').onclick = ()=>{
    const phone = $('bkPhone').value || 'Not provided';
    const name = $('bkName').value || 'Guest';
    $('bookContent').innerHTML = `<div><strong>Booking confirmed</strong><div class="tiny">Driver: ${v.driver}</div><div class="tiny">Vehicle: ${v.reg}</div><div class="tiny">Passenger: ${name} ‚Ä¢ ${phone}</div></div>`;
    setTimeout(()=>$('bookModal').classList.remove('show'),2000);
  };
}
$('closeBookModal').addEventListener('click',()=>$('bookModal').classList.remove('show'));

/* ---------------------------
  VIEW ROUTE FOR VEHICLE (simulated)
----------------------------*/
function viewRouteForVehicle(v){
  // clear previous ambulance routes
  state.ambulanceRoutes.forEach(r=> state.map.removeLayer(r));
  state.ambulanceRoutes = [];
  // draw polyline from vehicle path
  const poly = L.polyline(v.path,{color: v.type==='ambulance' ? '#ff5c6c' : '#ffd966',weight:4,dashArray:'6,6'}).addTo(state.map);
  state.ambulanceRoutes.push(poly);
  $('notifList').insertAdjacentHTML('afterbegin', `<div class="tiny">Route shown for ${v.label} ${v.reg}</div>`);
  // if ambulance intersects user's approximate path -> notify
  if(v.type==='ambulance' && state.userCoords){
    const userLatLng = state.userCoords;
    const d = state.map.distance(userLatLng, v.path[0]);
    if(d < 2000) showNotification('‚ö†Ô∏è Ambulance nearby on map', `Ambulance may intersect your path (${Math.round(d)} m)`);
  }
  $('vehicleModal').classList.remove('show');
}

/* ---------------------------
  AMBULANCE SIMULATION TRIGGER
----------------------------*/
$('simulateAmbulanceBtn').addEventListener('click',()=>{
  const amb = state.vehicles.find(x=>x.type==='ambulance') || rndPick(state.vehicles);
  viewRouteForVehicle(amb);
  showNotification('Ambulance simulated', `Viewing ambulance route (${amb.reg})`);
});

/* ---------------------------
  OPEN STORE & ORDER FLOW
----------------------------*/
function openStore(store){
  $('storeTitle').innerText = store.name + ' ‚Ä¢ ' + store.cat;
  const list = $('productList'); list.innerHTML='';
  store.products.forEach(p=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.gap='8px'; div.style.padding='8px'; div.style.alignItems='center';
    div.innerHTML = `<img src="${p.img}" width="60" height="60" style="border-radius:8px;object-fit:cover"/><div style="flex:1"><div><strong>${p.name}</strong></div><div class="tiny">‚Çπ ${p.price}</div><div class="tiny">${p.desc}</div></div>`;
    const btn = document.createElement('button'); btn.className='btn primary'; btn.innerText='Order';
    btn.onclick = ()=>openOrderModal(p, store);
    div.appendChild(btn);
    list.appendChild(div);
  });
  $('storeModal').classList.add('show');
}
$('closeStore').addEventListener('click',()=>$('storeModal').classList.remove('show'));

function openOrderModal(product, store){
  $('orderProduct').innerHTML = `<div><strong>${product.name}</strong><div class="tiny">From: ${store.name}</div><div class="tiny">Price: ‚Çπ${product.price}</div></div>`;
  $('orderPhone').value=''; $('orderAddress').value=''; $('orderQty').value=1;
  $('orderModal').classList.add('show');
  $('confirmOrderBtn').onclick = ()=>{
    const phone = $('orderPhone').value || 'Not provided';
    const address = $('orderAddress').value || 'Not provided';
    const qty = $('orderQty').value || 1;
    // simulate sending order - show success and add to notif list
    $('orderModal').classList.remove('show');
    showNotification('Order received', `${product.name} x${qty} ‚Äî ${phone}`);
    $('notifList').insertAdjacentHTML('afterbegin',`<div class="tiny">Order: ${product.name} x${qty} ‚Ä¢ ${phone}</div>`);
    alert('Order received successfully! (demo)');
  };
}
$('cancelOrderBtn').addEventListener('click',()=>$('orderModal').classList.remove('show'));

/* ---------------------------
  PROFILE & DOCUMENTS
----------------------------*/
$('openProfile').addEventListener('click',()=>openProfile());
$('closeProfile').addEventListener('click',()=>$('profileModal').classList.remove('show'));
function openProfile(){
  const docs = ['Driving Licence','RC','PAN Card','Aadhaar Card','Registration No','Insurance','Pollution Cert','Address Proof'];
  const container = $('docList'); container.innerHTML='';
  docs.forEach((d,i)=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<strong>${d}</strong><div class="tiny">Dummy ‚Ä¢ ${d.slice(0,10)}-${i+1}</div><div style="height:8px"></div><img src="https://via.placeholder.com/120x80?text=${encodeURIComponent(d)}" style="width:100%;border-radius:8px;object-fit:cover"/>`;
    container.appendChild(card);
  });
  $('profileModal').classList.add('show');
}

/* ---------------------------
  FIND MY LOCATION
----------------------------*/
$('locBtn').addEventListener('click', ()=> {
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    if(state.userMarker){ state.map.removeLayer(state.userMarker) }
    state.userCoords = [lat,lng];
    state.userMarker = L.circleMarker([lat,lng],{radius:8,color:'#66ff99',fillColor:'#66ff99',fillOpacity:0.9}).addTo(state.map);
    state.map.setView([lat,lng],15,{animate:true});
    showNotification('Location found', `You are at ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
  }, err=>{
    alert('Unable to get location: ' + (err.message || 'permission denied'));
  },{enableHighAccuracy:true,timeout:8000});
});

/* ---------------------------
  DRAWER / UI BINDING
----------------------------*/
function bindUI(){
  // vehicle filters
  const vf = $('vehicleFilters');
  VEHICLE_TYPES.forEach(v=>{
    const id = 'chk_'+v.key;
    const label = document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
    label.innerHTML = `<input type="checkbox" id="${id}" checked/> <span class="badge">${v.icon} ${v.label}</span>`;
    vf.appendChild(label);
    $(id).addEventListener('change', (e)=>{
      if(e.target.checked) state.filters.add(v.key); else state.filters.delete(v.key);
      moveVehicles();
    });
  });

  // storeSelect list
  $('listStoresBtn').addEventListener('click', ()=>{
    const cat = $('storeSelect').value;
    if(!cat){ alert('Select a category'); return; }
    const list = state.stores.filter(s=>s.cat===cat);
    const html = list.map(s=>`<div class="tiny"><strong>${s.name}</strong> ‚Ä¢ <button class="btn" data-id="${s.id}">Open</button></div>`).join('');
    $('notifList').innerHTML = html;
    // bind open buttons
    document.querySelectorAll('#notifList button').forEach(b=>{
      b.addEventListener('click',()=>{ const id = b.dataset.id; const store = state.stores.find(s=>s.id===id); if(store) openStore(store); });
    });
  });

  // drawer open/close
  const drawer = $('drawer');
  $('openDrawerBtn').addEventListener('click', toggleDrawer);
  $('drawerHandle').addEventListener('click', toggleDrawer);
  // quick toggles
  $('toggleVehicleVisibility').addEventListener('click', ()=>{
    state.vehicleVisible = !state.vehicleVisible; moveVehicles();
    $('toggleVehicleVisibility').innerText = state.vehicleVisible ? 'Hide vehicles' : 'Show vehicles';
  });
  $('centerMapBtn').addEventListener('click', ()=> state.map.setView([28.6139,77.2090],13));
  $('toggleStores').addEventListener('click', ()=>{
    const show = state.storeMarkers.some(m=>state.map.hasLayer(m));
    state.storeMarkers.forEach(m=>{ if(show) state.map.removeLayer(m); else m.addTo(state.map) });
  });

  // toggleVehicles top button
  $('toggleVehicles').addEventListener('click', ()=>{
    state.vehicleVisible = !state.vehicleVisible; moveVehicles();
    $('toggleVehicles').innerText = state.vehicleVisible ? 'Hide Vehicles' : 'Show Vehicles';
  });

  // show ambulance routes button
  $('showAmbulanceRoutes').addEventListener('click', ()=> {
    state.vehicles.filter(v=>v.type==='ambulance').slice(0,3).forEach(v=> viewRouteForVehicle(v));
  });

  // center map zoom slider
  $('zoomInput').addEventListener('input', (e)=> state.map.setZoom(Number(e.target.value)));

  // open bookings (not implemented backend) -> show notif list
  $('openBookings').addEventListener('click', ()=> {
    $('notifList').innerHTML = '<div class="tiny">No bookings yet (demo)</div>';
    toggleDrawer(true);
  });

  // simulate drag for drawer (basic)
  let startY = 0, startTransform = 0, dragging=false;
  const el = drawer;
  el.addEventListener('touchstart', (ev)=>{ startY = ev.touches[0].clientY; dragging=true; });
  el.addEventListener('touchmove', (ev)=>{ if(!dragging) return; const dy = ev.touches[0].clientY - startY; if(dy>0) el.style.transform = `translateY(${dy}px)`; });
  el.addEventListener('touchend', ()=>{ dragging=false; el.style.transform=''; });
}

/* ---------------------------
  DRAWER UTIL
----------------------------*/
function toggleDrawer(force){
  const d = $('drawer');
  state.drawerOpen = typeof force==='boolean' ? force : !state.drawerOpen;
  if(state.drawerOpen) d.classList.add('drawer-open'); else d.classList.remove('drawer-open');
}

/* ---------------------------
  NOTIFICATIONS
----------------------------*/
function showNotification(title, msg){
  $('notifBox').style.display='block';
  $('notifBox').innerHTML = `<strong>${title}</strong><div class="tiny">${msg}</div>`;
  $('notifList').insertAdjacentHTML('afterbegin', `<div class="tiny"><strong>${title}</strong> ‚Ä¢ ${msg}</div>`);
  setTimeout(()=>{$('notifBox').style.display='none'},4000);
}

/* ---------------------------
  UTILS
----------------------------*/
function updateFilterCounter(){
  const visibleCount = state.vehicleMarkers.filter(v=>{
    const vis = state.filters.has(v.vehicle.type) && state.vehicleVisible;
    return vis;
  }).length;
  $('filterCount').innerText = `Vehicles: ${visibleCount}`;
}

/* ---------------------------
  LAUNCH
----------------------------*/
initMap();
</script>
</body>
</html>
